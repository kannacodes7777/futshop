{% extends 'base.html' %}
{% load static %}

{% block title %}All Products - Futshop{% endblock title %}

{% block content %}
<div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    
    <div class="flex justify-between items-center mb-6 border-b pb-4">
        <h3 class="text-3xl font-bold text-gray-800">All Products</h3>
        <div class="flex items-center space-x-4">
            <button id="refresh-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg shadow-sm flex items-center transition-transform transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M20 4h-5l-1.42 1.42A8.969 8.969 0 0012 5C7.03 5 3 9.03 3 14s4.03 9 9 9 9-4.03 9-9c0-1.61-.42-3.12-1.18-4.42L18.5 11" /></svg>
                Refresh
            </button>
            <a href="{% url 'main:add_product_page' %}" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-5 rounded-lg shadow-sm transition-transform transform hover:scale-105">
                Add New Product
            </a>
        </div>
    </div>
    
    <div id="loading-state" class="text-center py-12 hidden">
        <p class="text-gray-500 text-lg">Loading products...</p>
    </div>
    <div id="empty-state" class="text-center py-12 hidden">
        <p class="text-gray-500 text-lg">No products found. Click "Add New Product" to start.</p>
    </div>
    <div id="error-state" class="text-center py-12 hidden">
        <p class="text-red-600 text-lg">Failed to load products. Please try refreshing the page.</p>
    </div>

    <div id="product-list-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
    </div>
</div>

<div id="delete-confirm-modal" tabindex="-1" class="fixed top-0 left-0 right-0 z-50 hidden p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-full max-h-full bg-gray-900 bg-opacity-50 flex items-center justify-center">
    <div class="relative w-full max-w-md max-h-full">
        <div class="relative bg-white rounded-lg shadow-xl">
            <button id="close-delete-modal-btn" type="button" class="absolute top-3 right-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            </button>
            <div class="p-6 text-center">
                <svg class="mx-auto mb-4 w-14 h-14 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <h3 class="mb-5 text-lg font-normal text-gray-500">Are you sure you want to delete this product?</h3>
                <button id="confirm-delete-btn" type="button" class="text-white bg-red-600 hover:bg-red-800 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center mr-2">
                    Yes, I'm sure
                </button>
                <button id="cancel-delete-btn" type="button" class="text-gray-500 bg-white hover:bg-gray-100 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900">
                    No, cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script src="{% static 'js/toast.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

    const productListContainer = document.getElementById('product-list-container');
    const loadingState = document.getElementById('loading-state');
    const emptyState = document.getElementById('empty-state');
    const errorState = document.getElementById('error-state');
    const refreshBtn = document.getElementById('refresh-btn');

    const deleteConfirmModal = document.getElementById('delete-confirm-modal');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    const closeDeleteModalBtn = document.getElementById('close-delete-modal-btn');
    let productIdToDelete = null;

    const showDeleteModal = () => deleteConfirmModal.classList.remove('hidden');
    const hideDeleteModal = () => deleteConfirmModal.classList.add('hidden');
    
    refreshBtn.addEventListener('click', fetchProducts);
    cancelDeleteBtn.addEventListener('click', hideDeleteModal);
    closeDeleteModalBtn.addEventListener('click', hideDeleteModal);

    const showLoading = () => {
        loadingState.classList.remove('hidden');
        [emptyState, errorState, productListContainer].forEach(el => el.classList.add('hidden'));
    };
    const showEmpty = () => {
        emptyState.classList.remove('hidden');
        [loadingState, errorState, productListContainer].forEach(el => el.classList.add('hidden'));
    };
    const showError = () => {
        errorState.classList.remove('hidden');
        [loadingState, emptyState, productListContainer].forEach(el => el.classList.add('hidden'));
    };
    const showContent = () => {
        productListContainer.classList.remove('hidden');
        [loadingState, emptyState, errorState].forEach(el => el.classList.add('hidden'));
    };

    async function fetchProducts() {
        showLoading();
        try {
            const response = await fetch("{% url 'main:get_products' %}");
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();

            productListContainer.innerHTML = '';
            if (data.status === 'success' && data.products.length > 0) {
                showContent();
                data.products.forEach(product => {
                    productListContainer.insertAdjacentHTML('beforeend', `
                        <div class="product-card bg-white border rounded-lg shadow-sm overflow-hidden transform transition-transform hover:-translate-y-1" id="product-${product.id}">
                            <img src="${product.thumbnail || 'https://placehold.co/600x400/EEE/31343C?text=No+Image'}" alt="${product.name}" class="w-full h-48 object-cover">
                            <div class="p-4">
                                <h4 class="text-lg font-bold text-gray-800 truncate">${product.name}</h4>
                                <p class="text-sm text-gray-500">${product.category || 'Uncategorized'}</p>
                                <p class="font-semibold text-lg text-green-600 mt-2">Rp ${product.price}</p>
                                <div class="mt-4 flex space-x-2">
                                     <a href="/product/edit/${product.id}/" class="edit-btn text-center flex-1 bg-gray-200 hover:bg-green-500 hover:text-white text-gray-800 text-sm font-medium py-2 px-4 rounded-md transition">Edit</a>
                                     <button class="delete-btn flex-1 bg-red-500 hover:bg-red-600 text-white text-sm font-medium py-2 px-4 rounded-md transition" data-id="${product.id}">Delete</button>
                                </div>
                            </div>
                        </div>
                    `);
                });
            } else {
                showEmpty();
            }
        } catch (error) {
            console.error("Fetch error:", error);
            showError();
        }
    }

    productListContainer.addEventListener('click', (e) => {
        const deleteButton = e.target.closest('.delete-btn');
        if (deleteButton) {
            productIdToDelete = deleteButton.dataset.id;
            showDeleteModal();
        }
    });

    confirmDeleteBtn.addEventListener('click', async () => {
        if (!productIdToDelete) return;

        hideDeleteModal();
        try {
            const response = await fetch("{% url 'main:delete_product' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                body: JSON.stringify({ id: productIdToDelete }),
            });
            const result = await response.json();

            if (response.ok) {
                showToast(result.message, 'success');
                fetchProducts();
            } else {
                showToast(result.message || 'Failed to delete.', 'error');
            }
        } catch (error) {
            showToast('A server error occurred.', 'error');
        } finally {
            productIdToDelete = null;
        }
    });

    fetchProducts();
});
</script>
{% endblock scripts %}